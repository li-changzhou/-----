# 功能规范: 事件倒计时工具

**功能分支**: `001-countdown-timer`
**创建时间**: 2026-01-22
**修改时间**: 2026-01-22
**状态**: ✅ 已批准 - 可推进计划
**批准人**: 用户
**批准日期**: 2026-01-22
**澄清文档**: [CLARIFICATION_LOG.md](CLARIFICATION_LOG.md)
**输入**: 用户描述: "倒计时提示工具，可以提醒我距离某个日期有多少天，这个日期可以自定义命名，同时能够在手机上添加小卡片，小卡片上展示距'name'还有n天"

⚠️ **强制要求**（章程驱动）: 此规范必须包含至少一个 P1 用户故事，且该故事必须能够独立测试和交付。规范必须得到利益相关者批准后，才能启动计划和实施阶段。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基于日期的事件倒计时 (优先级: P1)

作为一个用户，我想能够创建自定义命名的事件倒计时，基于目标日期自动计算距离该日期的天数，以便我可以随时了解距离重要日期还有多少天（如生日、假期、截止日期等）。

**优先级原因**: 这是事件倒计时工具的核心功能，是 MVP。用户可以创建任意数量的事件倒计时，查看每个事件的剩余天数。

**独立测试**: 可以通过 CLI 或 API 创建事件、查询天数、验证计算正确性。这是一个完整的、可独立交付的功能。

**验收场景**: 

1. **给定** 用户创建事件 `add "生日" 2026-03-15` **当** 系统记录此事件 **那么** 立即显示"生日还有 52 天"

2. **给定** 当前日期为 2026-01-22，事件日期为 2026-01-22 **当** 用户查询此事件 **那么** 显示"还有 0 天"

3. **给定** 用户查询已创建的事件 `list` **当** 系统获取所有事件 **那么** 显示所有事件及其剩余天数（格式："事件名 n 天"）

4. **给定** 用户删除事件 `delete "生日"` **当** 系统移除此事件 **那么** 事件不再显示在列表中

5. **给定** 用户输入无效日期格式 `add "事件" invalid` **当** 系统验证输入 **那么** 显示错误并提示正确格式 (YYYY-MM-DD)

6. **给定** 用户输入已过期的日期 `add "事件" 2026-01-01` **当** 当前日期为 2026-01-22 **那么** 系统仍然接受并显示"还有 0 天"

7. **给定** 用户创建事件 `add "生日" 2026-03-15` **当** 用户再次尝试创建同名事件 `add "生日" 2026-04-10` **那么** 系统拒绝操作并显示"事件 '生日' 已存在，请使用不同的名称"

8. **给定** 系统日期从 2026-01-22 修改为 2026-01-23 **当** 用户查询事件倒计时 **那么** 显示更新后的天数（如生日从 52 天变为 51 天）

---

### 用户故事 2 - 手机小卡片集成 (优先级: P2)

作为一个用户，我想能够在手机上添加事件倒计时的小卡片，小卡片实时显示"事件名还有 n 天"，以便我可以在主屏幕上一目了然地查看重要日期的倒计时。

**优先级原因**: 这扩展了功能的实用性，适配移动设备。但不是 MVP 的必需项。用户可以仅通过 CLI/Web 界面使用核心功能。

**独立测试**: 可以通过移动应用配置小卡片、验证显示数据、确认更新频率。小卡片需要与后端 API 同步数据。

**验收场景**: 

1. **给定** 用户在手机上安装应用并登录 **当** 用户创建事件倒计时 **那么** 用户可以添加小卡片到主屏幕

2. **给定** 小卡片已添加到主屏幕 **当** 每天 00:00 触发更新 **那么** 小卡片显示最新的剩余天数

3. **给定** 用户点击小卡片 **当** 打开应用详情页 **那么** 显示该事件的完整信息和倒计时历史

4. **给定** 用户删除事件 **当** 后端同步删除通知 **那么** 小卡片消失或显示已删除状态

---

### 用户故事 3 - 事件倒计时分享与通知 (优先级: P3)

作为一个用户，我想能够分享事件倒计时链接给他人，并配置通知提醒（如距离事件还有 7 天、3 天、1 天时提醒），以便我可以与朋友分享重要日期，并提前获得提醒。

**优先级原因**: 这是高级功能，仅对需要社交分享和通知功能的用户有用。不影响基础倒计时功能。

**独立测试**: 可以通过生成分享链接、配置通知规则、验证通知触发来测试。

**验收场景**: 

1. **给定** 用户生成事件的分享链接 `share "生日"` **当** 系统返回一个唯一链接 **那么** 他人可以通过链接访问此事件的倒计时

2. **给定** 用户配置通知规则 `notify "生日" 7,3,1` **当** 系统记录规则 **那么** 在 7 天、3 天、1 天前接收通知

3. **给定** 通知时间到达 **当** 系统检查通知规则 **那么** 向用户发送推送通知或邮件提醒

---

### 边界情况

- 当用户输入无效日期格式（如 "abc" 或 "2026-13-01"）时会发生什么？系统应显示错误消息并提示正确的 YYYY-MM-DD 格式。
- 当用户输入的目标日期早于当前日期时会发生什么？系统应显示"已过期（0 天）"或拒绝并提示输入未来日期。
- 当用户创建重名事件时会发生什么？**系统应拒绝创建并返回错误消息**："事件 '{name}' 已存在，请使用不同的名称"。
- 当用户修改系统日期时会发生什么？应该重新计算所有事件的倒计时天数。
- 当用户在多个设备上同步事件时会发生什么？应该保持数据一致性。

## 需求 *(必填)*

### 功能需求 (P1)

- **FR-001**: 系统必须支持创建命名的事件倒计时，指定目标日期（YYYY-MM-DD 格式）
- **FR-002**: 系统必须每天自动更新并计算事件距离当前日期的天数（精度：天）
- **FR-003**: 系统必须查询已创建的事件，显示"事件名 n 天"格式
- **FR-004**: 系统必须支持删除已创建的事件
- **FR-005**: 系统必须验证输入日期的有效性（YYYY-MM-DD 格式、有效的日期值）
- **FR-006**: 系统必须在当前日期等于或超过目标日期时显示"0 天"（而非负数）
- **FR-007**: 系统必须在人类可读的 CLI 或 API 中显示所有事件和天数
- **FR-008**: 系统必须支持结构化日志（可选 JSON 模式），用于集成和调试
- **FR-008a**: 系统必须在创建重名事件时拒绝操作，返回错误消息并告知事件已存在
- **FR-008b**: 系统必须正确维护事件状态转换：ACTIVE → CURRENT → EXPIRED（基于日期比较），删除事件转为 DELETED 状态
- **FR-008c**: 事件名称最大长度为 256 个字符，事件名称必须非空且不能包含制表符或换行符

### 功能需求 (P2)

- **FR-009**: 系统必须提供 REST API 接口，支持创建、查询、删除事件
- **FR-010**: 系统必须提供移动应用（iOS/Android）支持，使用户能添加小卡片到主屏幕
- **FR-011**: 系统必须每天 00:00 UTC 时更新小卡片显示的天数

### 功能需求 (P3)

- **FR-012**: 系统必须支持生成事件分享链接，供他人查看倒计时
- **FR-013**: 系统必须支持配置通知规则（如距离事件 7 天、3 天、1 天前通知）
- **FR-014**: 系统必须在触发通知规则时发送推送通知或邮件提醒

### 非功能需求

- **NFR-001**: 天数计算精度必须准确（基于日期差计算，精度：天）
- **NFR-002**: CLI 操作响应时间 < 500ms
- **NFR-003**: API 响应时间 < 200ms（p95）
- **NFR-004**: 支持至少 100 个并行事件倒计时
- **NFR-005**: 支持最长 100 年的倒计时（到 2126 年）
- **NFR-006**: 数据应持久化，支持应用重启后恢复所有事件
- **NFR-007**: **时区处理策略**：
  - P1 (CLI): 所有日期计算基于系统本地时区，无时区感知（假设用户在同一时区）
  - P2 (API): 所有日期内部使用 UTC 存储，但显示时采用用户设备的本地时区
  - 跨越午夜边界：倒计时基于日期差（不考虑具体时刻），每日 00:00 本地时间刷新一次

### 关键实体

- **Event**：表示一个事件倒计时实例
  - 属性：
    - `name` (string): 事件名称，唯一标识符
    - `target_date` (date): 目标日期 (YYYY-MM-DD)
    - `created_at` (datetime): 创建时间
    - `remaining_days` (int): 距离目标日期的天数（计算属性，每次查询时计算）
    - `status` (enum): 状态，可选值：
      - `ACTIVE`: 事件已创建，尚未到期（remaining_days > 0）
      - `CURRENT`: 事件日期为今天（remaining_days = 0）
      - `EXPIRED`: 事件已过期（remaining_days < 0）
      - `DELETED`: 事件已删除（软删除，保留历史数据）
  
- **Notification**：表示配置的通知规则 (P3)
  - 属性：
    - `event_name` (string): 关联的事件名
    - `days_before` (int): 距离事件前 N 天时触发
    - `notification_type` (enum): 通知类型 (PUSH, EMAIL, SMS)
    - `created_at` (datetime): 创建时间

- **Widget**：表示移动设备上的小卡片 (P2)
  - 属性：
    - `id` (uuid): 卡片唯一标识符
    - `event_name` (string): 关联的事件名
    - `device_id` (string): 设备标识符
    - `last_updated_at` (datetime): 最后更新时间
    - `display_text` (string): 显示的文本（"事件名 n 天"）

## 超出范围（版本 1.0）

- ❌ 图形用户界面（GUI）- 仅支持 CLI（P1）和 API（P2）
- ❌ 实时倒计时显示 - 仅支持天级精度，每天更新一次
- ❌ 倒计时历史记录和统计 - 仅记录当前状态
- ❌ 与第三方日历应用集成（如 Google Calendar）- 仅独立应用
- ❌ 语音提醒 - 仅支持推送通知和邮件

## 成功标准

### 可衡量的结果 (P1 MVP)

- **SC-001**: 用户可以在 < 2 秒内通过 CLI 创建事件倒计时
- **SC-002**: 天数计算精度 100%（通过对比官方日期差计算验证）
- **SC-003**: 所有 P1 验收场景通过率 100%
- **SC-004**: 测试覆盖率 ≥ 90%（关键路径）
- **SC-005**: CLI 应用可在所有主流平台上运行（Linux、macOS、Windows）

### 用户体验标准

- **SC-006**: 新手用户能在 < 2 分钟内创建第一个事件
- **SC-007**: 错误消息清晰，用户能快速理解修正方式

### 技术债务标准

- **SC-008**: 代码遵循 PEP 8（如 Python），无 linting 警告
- **SC-009**: 每个公开方法都有文档字符串
- **SC-010**: 支持数据持久化，重启后数据不丢失

## 技术方案（已确认）

- **核心语言**: Python 3.11+（跨平台，易于部署和测试）
- **CLI 框架**: Click（清晰的 API、易于测试、装饰器模式）
- **数据存储**: JSON 文件（P1/MVP）或 SQLite（P2+）
- **API 框架**: FastAPI（如需要 P2 REST API）
- **移动应用**: Flutter 或 React Native（如需要 P2 小卡片）
- **日期计算**: Python 标准库 `datetime` 模块

### 架构概述

```
P1 (MVP - CLI):
├── CLI Entry (cli.py)
├── Event Manager (event_manager.py)
├── Validation (validation.py)
├── Storage (storage.py - JSON)
└── Formatter (formatter.py)

P2 (API + Mobile):
├── REST API (FastAPI)
├── Database (SQLite)
├── Sync Service
└── Mobile App (Flutter/RN)

P3 (社交 + 通知):
├── Notification Service
├── Sharing Service
└── Email/Push Service
```

---

**后续步骤**: 该规范已根据用户澄清完成更新，待最终批准后，将进入计划阶段。
