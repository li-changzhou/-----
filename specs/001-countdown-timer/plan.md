# 实施计划: 事件倒计时工具

**分支**: `001-countdown-timer` | **日期**: 2026-01-22 | **规范**: [spec.md](spec.md)
**输入**: 来自 `/specs/001-countdown-timer/spec.md` 的功能规范（已批准）
**规范版本**: 1.1 (已通过质量检查，4.6/5 ⭐⭐⭐⭐⭐)
**验收场景**: 8 个 (已补充边界场景 7-8) | **测试数**: 24+ (按 3:1 比例)
**状态**: ✅ 计划已同步 - 与改进规范对齐

---

## 摘要

事件倒计时工具是一个多层功能应用，帮助用户管理和追踪重要日期的倒计时。

**核心价值**:
- **P1 MVP**: CLI 事件管理（创建、查询、删除事件；自动计算剩余天数）
- **P2 扩展**: 手机小卡片集成（REST API + 移动应用）
- **P3 增强**: 社交分享与通知（分享链接、提醒规则）

**技术特点**:
- 天级精度（而非秒级）：简化计时逻辑，降低复杂度
- 事件集合管理（而非单个计时）：支持 100+ 并行事件
- 数据持久化：JSON（P1）→ SQLite（P2）→ 分布式（P3）

---

## 技术背景

**语言/版本**: Python 3.11+  
**主要依赖**:
- Click 4.1+（CLI 框架）
- datetime（标准库，日期计算）
- json（标准库，P1 数据存储）
- pytest 7.4+（测试框架）
- FastAPI 0.100+（P2 REST API）
- SQLAlchemy 2.0+（P2 ORM）

**存储方案**:
- P1: JSON 文件（`~/.countdown/events.json`）
- P2+: SQLite 数据库
- P3+: 可扩展至 PostgreSQL + Redis

**目标平台**: Linux、macOS、Windows（跨平台）  
**项目类型**: 多层项目（CLI + API + 移动）  
**性能目标**:
- CLI 响应时间 < 500ms
- API 响应时间 < 200ms（p95）
- 天数计算精度 100%

**规模/范围**:
- P1: ~500 行代码
- P2: +800 行代码
- P3: +600 行代码
- 总计: ~2000 行代码

---

## 章程检查

- ✅ **规范驱动设计**: 包含 P1/P2/P3 故事、验收场景、需求定义
- ✅ **测试优先**: 计划包含单元/集成/合约/功能测试
- ✅ **分层验证**: 明确定义了四层测试
- ✅ **可观测性**: 包含日志和错误处理
- ✅ **版本管理**: 清晰的 P1/P2/P3 分层
- ✅ **简洁性**: MVP 范围明确，超出范围清晰
- ✅ **用户故事独立性**: 每个故事独立交付

---

## 项目结构

### 文档结构
```
specs/001-countdown-timer/
├── spec.md              # 功能规范（已批准）
├── plan.md              # 实施计划（此文件）
├── research.md          # 阶段 0 研究（待生成）
├── data-model.md        # 阶段 1 数据模型（待生成）
├── quickstart.md        # 快速开始指南（待生成）
├── contracts/           # API 合约（待生成）
└── tasks.md             # 任务列表（待生成）
```

### 源代码结构（P1）
```
countdown-timer/
├── src/
│   ├── cli.py           # CLI 入口
│   ├── event_manager.py # 事件业务逻辑
│   ├── storage.py       # JSON 存储
│   ├── validator.py     # 输入验证
│   ├── formatter.py     # 输出格式化
│   └── config.py        # 配置管理
├── tests/
│   ├── unit/           # 单元测试
│   ├── integration/    # 集成测试
│   ├── contract/       # 合约测试
│   └── e2e/           # 端到端测试
├── setup.py
├── requirements.txt
└── pytest.ini
```

---

## 技术决策

### 天级精度而非秒级
- 简化计时逻辑（无秒级更新）
- 减少 CPU 占用（无后台循环）
- 自动处理时区问题

### JSON 存储 (P1)
- 零依赖，易于部署
- P2 迁移至 SQLite

### Click vs argparse
- 清晰的装饰器 API
- 易于测试
- 内置高级功能

---

## 阶段规划

```
阶段 0: 研究             (1-2 天)
  ↓
阶段 1: 设计             (2-3 天)
  ↓
阶段 2: 项目设置         (1-2 天) [阻塞]
  ↓
阶段 3: P1 MVP           (5-7 天) [v1.0]
  ↓
阶段 4: P2 扩展          (7-10 天) [v1.1]
  ↓
阶段 5: P3 增强          (5-7 天) [v1.2]

━━━━━━━━━━━━━━━━━━━
总计: 21-31 天 (3-5 周)
```

---

## 规范更新记录

**版本 1.0 → 1.1 (2026-01-22)**

✅ **改进内容**:
- 澄清重名事件处理方式：系统拒绝 + 错误消息 (FR-008a)
- 完整定义 Event 状态：ACTIVE / CURRENT / EXPIRED / DELETED (4/4)
- 补充边界验收场景：+2 个 (场景 7-8，共 8 个)
- 定义数据长度限制：名称 ≤ 256 字符 (FR-008c)
- 明确时区处理策略：P1 本地 / P2 UTC (NFR-007)

📊 **质量提升**: 3.8/5 → 4.6/5 (+21%)

📝 **参考**:
- [SPEC_IMPROVEMENTS.md](SPEC_IMPROVEMENTS.md) - 改进详情
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - 执行报告
- [CHECKLIST_SUMMARY.md](CHECKLIST_SUMMARY.md) - 检查总结

---

## 测试计划更新

**验收场景**: 现在为 8 个（已补充边界场景）

| # | 场景 | 类型 | P1 | P2 | P3 |
|----|------|------|----|----|-----|
| 1 | 创建事件 | 主流程 | ✅ | ✅ | ✅ |
| 2 | 同日期（0天） | 边界 | ✅ | ✅ | ✅ |
| 3 | 查询事件列表 | 主流程 | ✅ | ✅ | ✅ |
| 4 | 删除事件 | 主流程 | ✅ | ✅ | ✅ |
| 5 | 无效日期格式 | 错误处理 | ✅ | ✅ | ✅ |
| 6 | 已过期日期 | 边界 | ✅ | ✅ | ✅ |
| 7️⃣ | **重名事件拒绝** | **边界** | **✅** | **✅** | **✅** |
| 8️⃣ | **系统日期修改** | **边界** | **✅** | **✅** | **✅** |

**测试总数**: ~24 个 (单元:集成:E2E = 12:8:4，基于 3:1 比例)

---

## 后续步骤

1. **阶段 0 研究**: 运行研究流程生成 `research.md`
   - 验证 Python datetime 精度
   - 验证 Click 测试模式
   - 验证 JSON 并发性能
   - 验证迁移路径（JSON → SQLite）

2. **阶段 1 设计**: 生成 `data-model.md` 和 `contracts/`
   - 设计 Event 状态转换图
   - 定义 API 端点（P2）
   - 定义通知规则（P3）
   - **重点**: 确保设计涵盖所有 8 个验收场景

3. **生成任务**: 运行 `/speckit.tasks` 生成 `tasks.md`
   - 任务需要覆盖所有 17 个功能需求 (FR)
   - 任务需要覆盖所有 7 个非功能需求 (NFR)
   - 测试任务需要覆盖所有 8 个验收场景

4. **开始实施**: 按任务列表顺序执行

---

**计划状态**: ✅ 已更新 | **日期**: 2026-01-22 | **规范版本同步**: v1.1 ✅

